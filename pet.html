<!DOCTYPE html>
<html lang="CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>喵险随从</title>
    
    <style>
        input{
            height: clamp(10px,5vw,25px);
            width: clamp(80px,20vw,150px);
            margin-top: 1vh;
            border-radius: 5px;
            border: 2px solid #ff6f91;
        }
        .bg {
              position: absolute;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              background-size: cover;      
              background-position: center; 
              background-repeat: no-repeat;
              z-index: -1;
              background-image: url("img/pet/background.jpg");       
             }
        
        #gameCanvas {
            image-rendering: pixelated;
            width: clamp(300px,20vw,900px);
            height: clamp(450px,30vw,1200px);
            position: fixed;
            transform: translate(-50%);
            bottom: 10%;
            left: 35%;
            z-index: 1000;
            cursor:crosshair;
        }
        #gameCanvas:hover{
            transform: translate(-50%) scale(1.1);
            bottom: 15%;
        }
        p{
            margin: 0;
            font-size: clamp(18px,4vw,30px);
            color: rgba(220,100, 100,1);
            font-weight: 700;
            text-shadow:    
            3px 0 white,
            -3px 0 white,
            0 3px white,
            0 -3px white;
            user-select: none;
        }
        h1{
        font-size: clamp(18px,4vw,30px);text-align: center;
        color: rgba(220,100, 100,1);
            font-weight: 700;
            text-shadow:    
            3px 0 white,
            -3px 0 white,
            0 3px white,
            0 -3px white;
            user-select: none;
        }
        
    button{
    width: clamp(60px,13vw,100px);
    height: clamp(35px,8vw,60px);
    font-size: clamp(10px,4vw,30px);
    font-weight: 700;
    background:linear-gradient(150deg,rgba(200, 150,150, 1),rgba(200, 50,50, 1));
    color: white;
    border: 5PX solid white;
    border-radius: 10px;
    cursor: pointer;
    image-rendering: pixelated; 
    transition: transform  0.2s;
    margin: 5px;
    user-select: none;
    }

    button:active {
        transform:scale(0.9);
        background: #ffaa00;
    }
    
    button:hover{
        transform: scale(1.1);
        background: rgba(200, 50,50, 1);
    }
    .abillity{
        display: flex;
        flex-direction: column;
        gap: 15px;   
        background-color: rgba(255,255, 255,0.6);
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3);
        padding: 5px;
        text-align: left;
        transition: 0.3s;
        backdrop-filter: blur(5px) saturate(150%);
        border: 5px solid rgba(255, 255, 255, 0.6);
        flex: 1 1 280px;
        width: clamp(150px,30vw,500px);
        position: fixed;
        top: 1%;
        right: 1%;
        user-select: none;
    }
    .abillity:hover{
        transform: scale(1.05);
        top: 2%;
    }
    .buttonCantainer{
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-start;
    }
    .bottomLine{  
        background-color: rgba(0,0, 0,0.8);
        border-radius: 5px;
        padding: 5px;
        text-align: left;
        transition: 0.3s;
        color: white;
        font-weight: 700;
        backdrop-filter: blur(5px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.6);
        width: 98vw;
        position: fixed;
        transform: translateX(50%);
        right: 50%;
        bottom: 0;
        z-index: 1000;
        font-size: 4vh;
        user-select: none;
    }
    #alernText{
        font-size: 3vh;
        text-align: center;
    }
    #EXPcanvas{
        left: 1%;
        margin-left:8px;
        width:90%;
        height: 3vh;
    }
    .Menu{
        display: block;
        min-width: 300px;
        min-height: 300px;
        text-align: center;
        background: rgba(255,255, 255,0.8);
        border-radius: 15px;
        padding: 10px;
        transition: 0.6s;
        opacity: 0;
        color: white;
        font-weight: 700;
        backdrop-filter: blur(1px) saturate(150%);
        border: 3px solid rgba(255, 255, 255, 1);
        position: fixed;
        transform: translateX(50%);
        right: 50%;
        top: -100%;
        z-index: 1000;
        font-size: 4vh;
        user-select: none;
        pointer-events: none;
    }
    .Menu.show{
        pointer-events: initial;
        top: 30%;
        opacity: 1;
    }
    .feedFish{
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: fixed;
        right: 50%; 
        top: 35%;
        transform: translatex(50%);
        z-index: 1000;
        background-color: rgba(255,255, 255,0.6);
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3);
        padding: 5px;
        text-align: left;
        transition: 0.3s;
        backdrop-filter: blur(5px) saturate(150%);
        border: 5px solid rgba(255, 255, 255, 0.6);
        width: clamp(200px,30vw,500px);
        flex: 1 1 280px;
        font-size: clamp(18px,4vw,50px);
            color: rgba(220,100, 100,1);
            font-weight: 700;
            text-shadow:    
            3px 0 white,
            -3px 0 white,
            0 3px white,
            0 -3px white;
    }
    .feedFish.show{
        display: flex;
    }
    #feedup{
        width: clamp(50px,15vw,100px);
        height: clamp(30px,6vw,60px);
        margin-top: 15px;
        font-size: clamp(10px,3vw,30px)
    }
    .spinner{
        display: inline-block;
        width: clamp(8px,4vw,16px);
        height: clamp(8px,4vw,16px);
        border: 6px solid rgba(255, 255, 255, 0.8);
        border-top: 6px solid rgba(200, 150, 150, 0.8);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .battleArea{
        display: none;
        position: fixed;
        transform: translateX(50%) translateY(-50%);
        top: 50%;
        right: 50%;
        width: clamp(300px,100vw,800px);
        height: clamp(200px,70vw,400px);
        background-image: url("img/pet/battlebackground.jpg");
        background-size: cover;      
        background-position: center; 
        background-repeat: no-repeat;
        z-index: 2000;
        user-select: none
    }
    .battleArea.show{
        display: block;
    }
    .battleShow{
        display: block;
        transition: 1s;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        right: 0;
        background-color: rgba(200, 50,50, 0);
        pointer-events: none;
        z-index: 2001;
    }
    .battleShow.attack{
        background-color: rgba(200, 50,50, 0.8);
        transform:scale(1.06)
    }
    .battleShow.heal{
        background-color: rgba(50,200,50, 0.8);
        transform: scale(1.06)
    }
   
    .battleCover{
        display: none;
        width: 200%;
        height: 200%;
        position: fixed;
        transform: translateX(50%) translateY(-50%);
        top: 50%;
        right: 50%;
        z-index: 1999;
        background-color: rgba(255,255,255, 0.2);
        pointer-events: none;
    }
    .battleCover.show{
        display: block;
        pointer-events:initial;
    }

    #battleEscape{
        position: fixed;
        right: 5%;
        bottom: 5%;
        width: clamp(60px,10vw,100px);
        height: auto;
        font-size: clamp(12px,4vw,20px);
        border-radius: 10px;
    }
    #petBattleCanvas{
        width: 20%;
        height: 33%;
        position: fixed;
        left: 15%;
        bottom: 40%;
    }
    #enemyBattleCanvas{
        position: fixed;
        width: 20%;
        height: 50%;
        left: 65%;
        bottom: 40%;
    }
    .skillBtm{
        width: clamp(60px,10vw,100px);
        height: auto;
        font-size: clamp(12px,4vw,20px);
        border-radius: 10px;
    }
    .skillContainer{
        display: flex;
        align-items: left;
        justify-content: left;
        position: fixed;
        left: 5%;
        bottom: 5%;
        width: 30%;
        height: 20%;
    }
    .battletop{
        display: block;
        text-align: center;
        background: rgba(0, 0,0, 0.6);
        height: clamp(20px,6vw,40px);
    }
    .tipsText{
        position: absolute;
        font-size: clamp(16px,4vw,30px);
        color: lightpink;
        font-weight: 700;
    }
    #enemyLevel{
        display: inline-block;
        position: fixed;
        top:10%;
        right: 2%;
        background:rgba(0, 0,0, 0.6)
    }
       #logAnime{
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            z-index: 5000;
            background-color: rgba(200, 200,255, 0.5);
            font-size: clamp(10px, 4vw, 25px);
           font-weight: 700;
           color: lightpink;
           text-shadow:
               1px 0 white,
               -1px 0 white,
               0 1px white,
               0 -1px white;
        }
        #loop{
            border: 6px solid white;
            border-top: 6px solid aqua;
            border-radius: 50%;
            width: clamp(10px,5vw,25px);
            height: clamp(10px,5vw,25px);
            animation: loop 1s linear infinite;
        }
        @keyframes loop {
            0%{transform:rotate(0deg);}
            100%{transform:rotate(360deg);}
        }
        .petChooseCard{
        display: none;
        align-items: center;
        justify-content: center;
        position: fixed;
        right: 50%; 
        top: 20%;
        transform: translatex(50%);
        z-index: 1000;
        background-color: rgba(255,255, 255,0.6);
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3);
        padding: 20px;
        transition: 0.3s;
        backdrop-filter: blur(5px) saturate(150%);
        border: 5px solid rgba(255, 255, 255, 0.6);
        flex: 1 1 280px;
        user-select: none;
        font-size: clamp(18px,4vw,50px);
            color: rgba(220,100, 100,1);
            font-weight: 700;
            text-shadow:    
            3px 0 white,
            -3px 0 white,
            0 3px white,
            0 -3px white;
        } 
        .petChooseCard.show{
            display: flex;
        }
        .petchooseImg{
            width: clamp(80px,12vw,200px);
            height: clamp(100px,16vw,300px);
            margin: 20px;
            transition: 0.5s;
            border: 5px solid  white;
            border-radius: 15px;
        }
        .petchooseImg:hover{
          transform: scale(1.2);
        }
       .exitBtm{
         position: absolute;
        top: 0;
        right: 0;
        padding: 0;
        border: none;
        background: none;
        border-radius: 0;
        width: clamp(20px,6vw,30px);
        height: clamp(20px,6vw,30px);
        font-size: clamp(20px,6vw,30px);
        color: rgba(200, 150,150, 1);
        margin: 0;
       }

    </style>
</head>

<body>
    <div id = "logAnime">
    加载中。。。<div id = "loop"></div>
    </div>
    <div class="bg"></div>
    <canvas id="gameCanvas"></canvas>
    <div class="abillity">
    <p>你的喵险随从</p>
    <p>名称：<span id = 'petName'></span></p>
        <p>等级：<span id = 'level'><span class="spinner"></span></span></p>
    <p>你的鱼干：<span id="fish"><span class="spinner"></span></span></p>
    <p>EXP：<span id="petEXP"><span class="spinner"></span></span></p>
    </div>
    <button id="showMenu" style="position: fixed;bottom: 20%;right:5%;width: clamp(60px,13vw,300px);height:clamp(50px,8vw,200px) ;">菜单</button>
    <div id="Menu" class="Menu">
        <button class="exitBtm" id="menuExit">X</button>
        <h1>菜单</h1>
            <button id="feedBtm">喂食</button>
            <button id="battle">冒险</button>
            <button id="switch">切换</button>
    </div>
    <div id='feedFishiWin' class = "feedFish">
        <button id="feedExit" class="exitBtm">X</button>
        <label for="usingFish" style="font-size: clamp(20px,6vw,35px);">你要投喂</label><input type="text" id="usingFish">
        <button id='feedup' >提交</button>
    </div>
    <div class="bottomLine">
        <div id="alernText"></div>
        <div style="width: 100%;">EXP:<canvas id="EXPcanvas"></canvas></div>
    </div>
    <div id="battleCover" class="battleCover"></div>
    <div id='battleWin' class="battleArea">
        <div id="battleShow" class="battleShow"></div>
        
        <div class="battletop">
        <span id='playerLife' class='tipsText'style="left:2%"></span>
        <span id='battletips'class='tipsText' style="transform: translateX(-50%); left:50%"></span>
        <span id='enemyLife'class='tipsText'style="right:2%"></span>
        <span id='enemyLevel'class='tipsText'></span>
        </div>
        <canvas id="petBattleCanvas"></canvas>
        <canvas id="enemyBattleCanvas"></canvas>
        <div class="skillContainer">
        <button id="skill1" class="skillBtm">攻击</button>
        <button id="skill2" class="skillBtm">回复</button>
        <button id="skill3" class="skillBtm">吸血</button>
        </div>
        <button id="battleEscape">逃跑</button>
    </div>
    <div id='petChooseCard' class='petChooseCard'>
    <button id="chooseExit" class="exitBtm">X</button>
    <h1 style="font-size: clamp(18px,4vw,30px);text-align: center;">选择宠物</h1>
    <img id="petChoose1" class="petchooseImg" src="./img/pet/pet1intro.jpg" alt="Aka">
    <img id="petChoose2" class="petchooseImg" src="./img/pet/pet2intro.jpg" alt="Shiro">
    </div>
    

    

</body>
<script src="fish.js"></script>
<script src="animetion.js"></script>
<script src="Index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
<script>
    let canBattle=false
    let canChangePet = localStorage.getItem('canChangePet')
    const petID = localStorage.getItem('petID')
   function loadAnime(a) {
    if(a === "run"){document.getElementById("logAnime").style.display = "flex"}
    if(a === "stop"){document.getElementById("logAnime").style.display = "none"}
    }

    const pet = new spriteAnimate('player',petID,'gameCanvas')
    addEventListener('load',async ()=>{
        try{
         loadAnime("run");
         await feedPet(0)
         updateLevel()
         document.getElementById('petName').textContent=petAnimeIndex[petID].name
         document.getElementById('alernText').textContent=waitWordIndex[petID]
         await pet.preLoad()
         canBattle=true}catch{alert('预加载错误'),window.location.href = "./MainPage.html"}
         finally{loadAnime("stop")}
     })

   
    const mainCanvas = document.getElementById('gameCanvas')
    let back = null
    mainCanvas.addEventListener('click',taptap)
    function taptap(){
        const replyWord =replyWordIndex[petID]
        const reply = Math.floor(Math.random()*replyWord.length)
        document.getElementById("alernText").textContent = replyWord[reply]
        clearTimeout(back)
        back = setTimeout(() => {
            document.getElementById("alernText").textContent = waitWord
        }, 2000);
    }

    const waitWord = waitWordIndex[petID]
    let eatback = null
      async function feed(){
        openWindow('close','feedFishiWin')
        let amount = Number(document.getElementById('usingFish').value)
        if(amount<=0){
              alert("太小气了喵")
              return }
        try{
          loadAnime("run")
          await feedPet(amount)
          await pet.setAction('eat')
        }
          catch{console.log('error')}
          finally{ loadAnime("stop")}
        clearTimeout(eatback)
        eatback = setTimeout(()=>{pet.setAction('stand')},4000)
        feedReply(amount)
        updateLevel()
    }
    function feedReply(amount){
         let reply = null
         if(amount<=2000){reply = 0}
         else if(amount<=5000){reply = 1}
         else if(amount<=10000){reply = 2}
         else if(amount<=20000){reply = 3}
         else if(amount<=50000){reply = 4}
         else {reply = 5}
        const relyText=feedRelyTextIndex[petID]
        document.getElementById("alernText").textContent = relyText[reply]
        back = setTimeout(() => {
            document.getElementById("alernText").textContent = waitWord
        }, 2000);
    }
    document.getElementById("feedup").addEventListener('click',feed)
    function remove(){
        this.value = this.value
        .replace(/\D/g,"")
    }
    document.getElementById('usingFish').addEventListener("input", remove);
    function updateLevel(){
        const EXP = Number(document.getElementById('petEXP').textContent);
        document.getElementById("level").textContent = `${Math.floor(EXP/10000)+1}级`
         drawEXP(EXP)
     }
     function drawEXP(EXP){
        const canvas = document.getElementById("EXPcanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight
        let EXPline = (EXP %10000)/10000 * canvas.width;
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "green";
        ctx.fillRect(0, 0, EXPline, canvas.height);
    }
    document.getElementById('petChoose1').addEventListener('click',()=>applychangePet(1));
    document.getElementById('petChoose2').addEventListener('click',()=>applychangePet(2));
    document.getElementById('switch').addEventListener('click',()=>{
        openWindow('open','petChooseCard')
        openWindow('close','Menu')
    });
    document.getElementById('chooseExit').addEventListener('click',()=>openWindow('close','petChooseCard'));
    document.getElementById('menuExit').addEventListener('click',()=>openWindow('close','Menu'));
    document.getElementById('showMenu').addEventListener('click',()=>openWindow('open','Menu'));
    document.getElementById('feedBtm').addEventListener('click',()=>{
        openWindow('open','feedFishiWin')
        openWindow('close','Menu')
        });
    document.getElementById('feedExit').addEventListener('click',()=>openWindow('close','feedFishiWin'));
    function openWindow(r,name){
        if(r==='open'){
        document.getElementById(name).classList.add('show')}
        else if(r==='close'){
        document.getElementById(name).classList.remove('show')}
    }
    async function applychangePet(id){
    canChangePet = localStorage.getItem('canChangePet')
    if(canChangePet==='false'){
        return alert('选择宠物已不可用')
        }
    const chooseConfirm =  window.confirm(`确定要更换为宠物${petAnimeIndex[id].name}吗？(只有一次机会更换宠物)`)
    if(chooseConfirm){
       try{
       loadAnime("run")
       await changePet(id)
       }catch{alert('网络错误')}
       finally{loadAnime("stop")}
    }
    
    else{
        alert('取消了更换')
    }
    }
    

 //战斗部分
 
    let gm = null
    async function loadGame(){
        if(!canBattle){return console.log('加载未完成')}
        gm = new gameManager()
        try{
        loadAnime("run")
        await gm.gameStart()
        }
        catch{console.log('error')}
        finally{loadAnime("stop")}
    }
    function destroyGame(){
        gm = null
    }
    
       
    document.getElementById('battle').addEventListener('click',()=>{
        openWindow('close','Menu')
        loadGame()
    });
    document.getElementById('battleEscape').addEventListener('click',()=>gm.escape());
    document.getElementById('skill1').addEventListener('click',()=>gm.playerAction(gm.player.skillkey1));
    document.getElementById('skill2').addEventListener('click',()=>gm.playerAction(gm.player.skillkey2));
    document.getElementById('skill3').addEventListener('click',()=>gm.playerAction(gm.player.skillkey3));     



</script>

</html>

