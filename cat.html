<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>猫咪赛跑</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .container {
              width: 90%;
               padding: 2vw;
}
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead {
            background-color: #ffb347;
            /* 渐变可以改成纯色或渐变 */
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        thead th {
            padding: 15px;
            text-align: left;
        }
        
        tr {
            background-color: #fff;
            transition: background-color 0.3s ease;
        }
        
        tr:nth-child(even) {
            background-color: #f7f7f7;
        }
        
        tr:hover {
            background-color: #ffe0b2;
        }
        
        tbody td {
            padding: 12px 15px;
        }
        
        caption {
            caption-side: top;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .tips {
            color: darkblue;
            font-size: clamp(12px, 4vw, 20px);
            font-weight: bold;
             display: flex;
            justify-content: center;
            align-items: center; /* 垂直居中 */
            gap: 2%;           /* 元素间距 */
            flex-wrap: wrap;
            margin-bottom: 2px;
        }
        .tips input, .tips button {
            display: inline-block;
        }
        @media (max-width: 500px) {
         .tips input, .tips button {
        display: inline-block;
        margin: 5px 0;
           }
        }
        #startBtn {
            margin: 20px;
        }
        
        #fish {
            background: deeppink
        }
    </style>
</head>

<body>
    <h1>猫咪赛跑</h1>
    <h2>游戏说明: 猜中即可获得奖励倍数的鱼干，猫的状态会影响获胜奖励</h2>
    <div class="tips">
        <canvas id="canvas"  style="border:1px solid deeppink;width:100%; max-width:800px; height:auto"></canvas><br>
    </div>

    <div class="tips"> 你的鱼干： <span  id="fish">0</span> </div>
    <div class="tips"><label>你要使用:<input id = "user_bet" class=tips type="number"></label>给</div>
    <div class="tips">
        <label><input type="radio" name="chooseCat" value="Ace Taffy">Ace Taffy</label>
        <label> <input type="radio" name="chooseCat" value="Seren Azuma">Seren Azuma</label>
        <label> <input type="radio" name="chooseCat" value="NyaRu">NyaRu</label>
        <label>  <input type="radio" name="chooseCat" value="Diana">Diana</label>
    </div>
    <div class="tips">
        <button onclick="bet()">确认</button>
    </div>
    <h2>获胜奖励</h2>
    <table id="betRate">
        <tr>
            <th>Ace Taffy</th>
            <th>Seren Azuma</th>
            <th>NyaRu</th>
            <th>Diana</th>
        </tr>
    </table>
    <h2>结果统计</h2>
    <table id="winner">
        <tr>
            <th>局数</th>
            <th>获胜猫</th>
            <th>你的选择</th>
            <th>鱼干变动</th>
        </tr>
    </table>
</body>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
       //这里开始是网络数据库部分

     const supabaseUrl = 'https://rvzfjypuxbptqxyxcmzu.supabase.co'
     const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2emZqeXB1eGJwdHF4eXhjbXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODIwNTksImV4cCI6MjA3Nzc1ODA1OX0.PYx4KzJgafbG8O_PPJbYQCVJs-iwTjIvVFoeiau0vnc'
     const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)
      const playerID = localStorage.getItem('logPlayerID');

    async function loadFish() {
        if(!playerID){
            alert("请先登录喵")
            window.location.href = "./index.html";
        }
        const {data,error} = await supabaseClient
            .from("player")
            .select("fish")
            .eq("id",playerID)
            .maybeSingle();
        if(error&&error.code !== "PGRST116"){console.error(error);return 0}
        let fish = data? data.fish : 0
        document.getElementById("fish").innerHTML = fish
        return fish
    }

    async function addFish(amount) {
        const {data:existing,error} = await supabaseClient
        .from("player")
         .select("fish")
        .eq("id",playerID)
        .maybeSingle();
        if(error){
            console.error(error)
            return;
        }
        if(!existing){
            console.log("账号不存在")
            return;
        }
        const newFish = existing.fish + amount;
        const {error:updateError} = await supabaseClient
        .from("player")
        .update({fish:newFish})
        .eq("id",playerID)
        if(updateError){
            console.error(error)
            return
        }
        document.getElementById("fish").innerHTML = newFish;
    }


    //游戏主体
    addEventListener("load", clearcanvans)
    addEventListener("load",loadFish)
    addEventListener("load", updateRate)
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetWidth*0.65;
    let winner
    let catwidth = 0.05*canvas.width;
    let cats = [{
        x: canvas.width * 0.1,
        y: canvas.height * 0.3,
        color: "pink",
        name: "Ace Taffy",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.5,
        color: "white",
        name: "Seren Azuma",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.7,
        color: "aqua",
        name: "NyaRu",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.9,
        color: "red",
        name: "Diana",
    }, ];

    function clearcanvans() {
        ctx.fillStyle = "aqua";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "lightgreen";
        ctx.fillRect(0, canvas.height * 0.2, canvas.width, canvas.height * 0.8);

        ctx.fillStyle = "#F00B0B";
        ctx.fillRect(canvas.width * 0.15, canvas.height * 0.2, 10, canvas.height * 0.8);
        ctx.fillRect(canvas.width *7 / 8, canvas.height * 0.2, 10, canvas.height * 0.8);

        let runway = [{
            x: canvas.width * 0.15 + 10,
            y: canvas.height * 0.4
        }, {
            x: canvas.width * 0.15 + 10,
            y: canvas.height * 0.6
        }, {
            x: canvas.width * 0.15 + 10,
            y: canvas.height * 0.8
        }, ];
        ctx.fillStyle = "white";
        runway.forEach(line => ctx.fillRect(line.x, line.y, canvas.width, 0.01*canvas.width));

        ctx.fillStyle = "deeppink";
        ctx.font = "clamp(8px, 2vw, 18px) sans-serif";
        cats.forEach(cat=>{ctx.fillText(cat.name, 0.015*canvas.width, cat.y + catwidth)});
    }

    function drawCat(ctx, x, y, size, color) {
        // 猫头
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
        ctx.fill();

        // 左耳
        ctx.beginPath();
        ctx.moveTo(x + size * 0.1, y + size * 0.3);
        ctx.lineTo(x + size * 0.3, y - size * 0.3);
        ctx.lineTo(x + size * 0.5, y + size * 0.3);
        ctx.closePath();
        ctx.fill();

        // 右耳
        ctx.beginPath();
        ctx.moveTo(x + size * 0.5, y + size * 0.3);
        ctx.lineTo(x + size * 0.7, y - size * 0.3);
        ctx.lineTo(x + size * 0.9, y + size * 0.3);
        ctx.closePath();
        ctx.fill();

        // 眼睛
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.arc(x + size * 0.3, y + size * 0.4, size * 0.08, 0, Math.PI * 2);
        ctx.arc(x + size * 0.7, y + size * 0.4, size * 0.08, 0, Math.PI * 2);
        ctx.fill();

        // 胡子
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        ctx.beginPath();
        // 右边胡子
        ctx.moveTo(x + size * 0.7, y + size * 0.6);
        ctx.lineTo(x + size * 1.1, y + size * 0.5);
        ctx.moveTo(x + size * 0.7, y + size * 0.7);
        ctx.lineTo(x + size * 1.1, y + size * 0.6);
        ctx.moveTo(x + size * 0.7, y + size * 0.75);
        ctx.lineTo(x + size * 1.1, y + size * 0.75);
        // 左边胡子
        ctx.moveTo(x + size * 0.3, y + size * 0.6);
        ctx.lineTo(x - size * 0.1, y + size * 0.5);
        ctx.moveTo(x + size * 0.3, y + size * 0.7);
        ctx.lineTo(x - size * 0.1, y + size * 0.6);
        ctx.moveTo(x + size * 0.3, y + size * 0.75);
        ctx.lineTo(x - size * 0.1, y + size * 0.75);
        ctx.stroke();
    }

    let gameReady = true;

    function moveCat() {
            clearcanvans();
            cats.forEach(cat => {
                let speed = cat.catSpeed+ Math.random()
                 if (Math.random() < cat.catSpeed*0.15) {speed=0.1*Math.random()*canvas.width}
                cat.x += speed;
                drawCat(ctx, cat.x, cat.y, catwidth, cat.color);
            });
            if (!cats.some(cat => (cat.x > canvas.width - 0.12*canvas.width))) {
                gameReady = false
                requestAnimationFrame(moveCat);
            } else {
                winner = cats.find(cat => (cat.x > canvas.width - 0.12*canvas.width));
                winner_check();
                clearcanvans();
                winnerCollect(winner.name,user_choice.cat,(winfish - user_choice.amount));
                reset()
            }
    }

    function main() {
        if (!gameReady) return
            clearcanvans();
            moveCat();
    }

    function reset() {
        cats = [{
        x: canvas.width * 0.1,
        y: canvas.height * 0.3,
        color: "pink",
        name: "Ace Taffy",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.5,
        color: "white",
        name: "Seren Azuma",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.7,
        color: "aqua",
        name: "NyaRu",
    }, {
        x: canvas.width * 0.1,
        y: canvas.height * 0.9,
        color: "red",
        name: "Diana",
    }, ];
        gameReady = true;
        choiceon = true;
        user_choice = {cat:null,amount:0}
        updateRate()
    }
    let gametimes = 0


    function winnerCollect(a,b,c) {
        gametimes += 1;
        const tableBody = document.getElementById("winner");
        const tr = document.createElement("tr");
        if (winner.name===b){
        tr.innerHTML = `
      <td style="background: pink">${gametimes}</td>
      <td style="background: pink">${a}</td>
      <td style="background: pink">${b}</td>
      <td style="background: pink">${c}</td>
    `}
        else {
            tr.innerHTML =`
            <td>${gametimes}</td>
            <td>${a}</td>
            <td>${b}</td>
            <td>${c}</td>
        `}
        tableBody.appendChild(tr)
    }
    let user_choice = {cat:null,amount:0}
    let choiceon = true
    const ratio = document.getElementsByName("chooseCat");
    function bet(){
        if (!gameReady) return;
        if(!choiceon)return;
         const user_bet = Number(document.getElementById("user_bet").value);
         let user_cat = null
        if(Number(document.getElementById("fish").innerText) - user_bet>=0) {
            ratio.forEach(c => {
                if (c.checked) {
                    user_cat = c.value
                }
            });
            if(user_cat === null || user_bet===0){
                alert("请正确投喂！")
                return;
            }
            user_choice.cat = user_cat;
            user_choice.amount = Math.round(Number(user_bet));
            alert("你给" + user_choice.cat + "投喂了" + user_choice.amount);
            addFish((-user_choice.amount));
            choiceon = false;
            main()
        }
        else {
            alert("没鱼了喵")
        }
    }
    let winfish = 0
    function winner_check(){
        winfish = 0
        if (user_choice.cat === winner.name){
            winfish = Math.round(winner.rate* user_choice.amount);
            addFish(winfish)
            alert("你赢了喵，获得了"+winfish+"条鱼");
            }
        else {
            alert("没猜中，你的鱼被吃完了喵，获胜者是"+winner.name)
        }
    }

    function updateRate(){
        cats.forEach(cat=>{cat.catSpeed = 0.01+Math.random()*0.05})
        const tableBody = document.getElementById("betRate");
        const tr = document.createElement("tr");
          while (tableBody.rows.length > 1) { // 如果上面加了说明行就 >2，否则 >1
          tableBody.deleteRow(2 - 1); // 从第二行开始删（保持表头）
            }
        const average = cats.reduce((acc, item) => acc+item.catSpeed,0)/cats.length;
        cats.forEach(cat=> {
            let rate = ((average / cat.catSpeed) ** 1.3) * 2.5
            cat.rate = Number(rate.toFixed(2))
        })
        tr.innerHTML = `
        <td>${cats[0].rate}</td>
        <td>${cats[1].rate}</td>
        <td>${cats[2].rate}</td>
        <td>${cats[3].rate}</td>
        `
        tableBody.appendChild(tr)
    }


</script>

</html>