<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>贪吃蛇</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        h1{
            margin:0;
        }
        body{
            text-align: center;
        }
        h2{
            color:  #ff6f91;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            margin: 2px;
            font-size: clamp(12px, 2vw, 16px);
        }
        #score{
            color: #ff6f91;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            margin: 2px;
        }
        #times{
            color: darkblue;
            font-weight: bold;
            text-align: center;
            background: deeppink;
            display: inline-block;
            margin: 2px;
        }
        .opbtm{
            width: clamp(20px,12vw,70px);
            height: clamp(20px,12vw,70px);
            text-align: center;
            font-weight: 700;
        }
        #fish{
            background-color: rgba(200,80,80,0.3);
        }

    </style>
</head>
<body>
<div id = "HeadLine"></div>
<div class="gamecard-container">
    <div class="gamecard">
<h2>你的鱼干:<span id="fish">0</span>（每分可以获得50鱼干）</h2><br>
<div id="score" style="display: block">分数:0分喵</div>
<canvas id = "Snakegame" style=" width:100% ;max-width: 400px; height:auto"></canvas><hr>
<button class = "opbtm" id = "up" onclick="move(0,-1)">↑</button>
<br>
<button class = "opbtm" id = "left" onclick="move(-1,0)" style="">←</button>
<button class = "opbtm" id ="down" onclick="move(0,1)">↓</button>
<button class = "opbtm" id = "right" onclick="move(1,0)" style="">→</button>
<hr>
<button id = "startbtn" onclick="gamestart()">开始喵！</button>
<br><button id = "shutdownbtn" onclick="freeze()">暂停/继续</button>
    </div>
</div>
</body>
<script src="HeadLine.js"></script>
<script src="fish.js"></script>
<script>
addEventListener("load",loadHeadLine);
addEventListener("resize", updateScreen)
addEventListener("load", updateScreen)
addEventListener("load", clearCanvas)
addEventListener("load", loadFish)
addEventListener("keydown",function(e){
    switch(e.key){
        case "ArrowLeft":move(-1,0)
            e.preventDefault();
            break;
        case "ArrowRight":move(1,0)
            e.preventDefault();
            break;
        case "ArrowUp":move(0,-1)
            e.preventDefault();
            break;
        case "ArrowDown":move(0,1)
            e.preventDefault();
        break;
    }
})
const canvas = document.getElementById("Snakegame");
let SnakeSize = 0.05 * canvas.width;
const ctx = canvas.getContext("2d");
function updateScreen() {
    const GRID = Math.floor(innerWidth*0.95/20)
    let updateWidth = Math.floor(innerWidth*0.95/GRID)
    let updateHeight = Math.floor(innerWidth*0.95/GRID)
    canvas.width = updateWidth * GRID;
    canvas.height = updateHeight * GRID;
    SnakeSize = GRID
    reset()
    clearCanvas();
}

let score = 0;
let snake =[]
let food = {}
let speed = 200;
function NewFood() {
    food.x = SnakeSize * Math.floor(Math.random() * (canvas.width / SnakeSize));
    food.y = SnakeSize * Math.floor(Math.random() * (canvas.height / SnakeSize));
    if (snake.some(segment=>(segment.x===food.x&&segment.y===food.y))){
        NewFood()
    }
    else {
        if (speed > 100) {
            speed -= 5
        }
        drawFood()
    }

}
let dx = SnakeSize;
let dy = 0
let movefeetx = dx
let movefeety = dy
function move(a,b) {
    paused = false
    if ((dx===0 && b*SnakeSize === -dy)||(dy===0 && a*SnakeSize === -dx)) return
        movefeetx = a * SnakeSize;
        movefeety = b * SnakeSize;
}

function clearCanvas(){
    ctx.fillStyle = "white";
    ctx.fillRect(0,0,canvas.width,canvas.height);
}//绘制和清空背景
function drawSnake(){
    ctx.fillStyle = "pink";
    snake.forEach(segment=>{
    ctx.fillRect(segment.x,segment.y,SnakeSize,SnakeSize);})
}
function  drawFood(){
    ctx.fillStyle = "green";
    ctx.fillRect(food.x,food.y,SnakeSize,SnakeSize);
}
async function moveSnake() {

    dx = movefeetx
    dy = movefeety
    const head = {x: snake[0].x + dx, y: snake[0].y + dy}
    if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height||snake.some(segment=> segment.x===head.x && segment.y===head.y)) {
        alert("似了喵T T")
        gametimes +=1
        setposition()
        await addFish((Number(score)*50))
        reset()
    }
    else {
        snake.unshift(head)
        if (head.x === food.x && head.y === food.y) {
            score = score + 1
            updatesocre()
            NewFood()
        } else {
            snake.pop()
        }
    }
}
function updatesocre(){
    document.getElementById("score").innerHTML = "分数:"+score+"分喵";
}
let gametimes = 0
function gamestart(){
    document.getElementById("score").innerHTML = "分数:"+0+"分喵"
    gametimes += 1;
    if(gametimes < 2){
        setposition()
        main()
    }
    else {
        clearTimeout(gameloop)
        reset()
        main()
    }
    document.getElementById("times").innerHTML = "你已游玩"+gametimes+"次";
}
let paused = false
function freeze(){
    paused = !paused
}
function main() {
    gameloop = setTimeout(function tick() {
        clearCanvas()
        if(!paused) {
            moveSnake()
        }
            drawSnake()
            drawFood()
        main()
    },speed);
}
function setposition(){
     snake =[
    {x:10*SnakeSize,y:10*SnakeSize},
    {x:9*SnakeSize,y:10*SnakeSize},
    {x:8*SnakeSize,y:10*SnakeSize},
        ]

    speed = 200
    paused = true
    movefeetx = SnakeSize;
    movefeety = 0
    drawSnake()
    NewFood()
}
function reset(){
    clearTimeout(gameloop)
    setposition()
    score = 0
    move(0,0)
    document.getElementById("score").innerHTML = "分数:"+0+"分喵"
}

</script>
</html>