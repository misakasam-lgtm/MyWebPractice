<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>贪吃蛇</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{
            text-align: center;
        }
        #score{
            color: darkblue;
            font-weight: bold;
            text-align: center;
            background: deeppink;
            display: inline-block;
            margin: 2px;
        }
        #times{
            color: darkblue;
            font-weight: bold;
            text-align: center;
            background: deeppink;
            display: inline-block;
            margin: 2px;
        }
        .opbtm{
            width: clamp(20px,12vw,70px);
            height: clamp(20px,12vw,70px);
        }
        hr{
            width: 60%;
        }
        button:hover {
    transform: scale(1.05);
    background: #ffafc4;}
    </style>
</head>
<body>
<h1>贪吃蛇喵</h1>
<div style="text-align: center"><div id="score">分数:0分喵</div><br><div id="times">你已游玩0次</div></div>
<canvas id = "Snakegame" style=" width:100% ;max-width: 400px; height:auto"></canvas><hr>
<button class = "opbtm" id = "up" onclick="move(0,-1)">↑</button>
<br>
<button class = "opbtm" id = "left" onclick="move(-1,0)" style="">←</button>
<button class = "opbtm" id ="down" onclick="move(0,1)">↓</button>
<button class = "opbtm" id = "right" onclick="move(1,0)" style="">→</button>


<hr>
<button id = "startbtn" onclick="gamestart()">开始喵！</button>
<br><button id = "shutdownbtn" onclick="freeze()">暂停/继续</button >

</body>
<script>
addEventListener("resize", updateScreen)
addEventListener("load", updateScreen)
addEventListener("load", clearCanvas)
const canvas = document.getElementById("Snakegame");
let SnakeSize = 0.05 * canvas.width;
const ctx = canvas.getContext("2d");
function updateScreen() {
    const GRID = Math.floor(innerWidth*0.95/20)
    let updateWidth = Math.floor(innerWidth*0.95/GRID)
    let updateHeight = Math.floor(innerWidth*0.95/GRID)
    canvas.width = updateWidth * GRID;
    canvas.height = updateHeight * GRID;
    SnakeSize = GRID
    reset()
    clearCanvas();
}


let score = 0;
let snake =[]
let food = {}
let speed = 200;
function NewFood() {
    food.x = SnakeSize * Math.floor(Math.random() * (canvas.width / SnakeSize));
    food.y = SnakeSize * Math.floor(Math.random() * (canvas.height / SnakeSize));
    if (snake.some(segment=>(segment.x===food.x&&segment.y===food.y))){
        NewFood()
    }
    else {
        if (speed > 100) {
            speed -= 5
        }
        drawFood()
    }

}
let dx = SnakeSize;
let dy = 0
let movefeetx = dx
let movefeety = dy
function move(a,b) {
    if ((dx===0 && b*SnakeSize === -dy)||(dy===0 && a*SnakeSize === -dx)) return
        movefeetx = a * SnakeSize;
        movefeety = b * SnakeSize;
}

function clearCanvas(){
    ctx.fillStyle = "white";
    ctx.fillRect(0,0,canvas.width,canvas.height);
}//绘制和清空背景
function drawSnake(){
    ctx.fillStyle = "pink";
    snake.forEach(segment=>{
    ctx.fillRect(segment.x,segment.y,SnakeSize,SnakeSize);})
}
function  drawFood(){
    ctx.fillStyle = "green";
    ctx.fillRect(food.x,food.y,SnakeSize,SnakeSize);
}
function moveSnake() {
    dx = movefeetx
    dy = movefeety
    const head = {x: snake[0].x + dx, y: snake[0].y + dy}
    if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height||snake.some(segment=> segment.x===head.x && segment.y===head.y)) {
        alert("似了喵T T")
        gametimes +=1
        document.getElementById("times").innerHTML = "你已游玩"+gametimes+"次";
        reset()
    }
    else {
        snake.unshift(head)
        if (head.x === food.x && head.y === food.y) {
            score = score + 1
            updatesocre()
            NewFood()
        } else {
            snake.pop()
        }
    }
}
function updatesocre(){
    document.getElementById("score").innerHTML = "分数:"+score+"分喵";
}
let gametimes = 0
function gamestart(){
    document.getElementById("score").innerHTML = "分数:"+0+"分喵"
    gametimes += 1;
    if(gametimes < 2){
        setposition()
        main()
    }
    else {
        clearTimeout(gameloop)
        reset()
        main()
    }
    document.getElementById("times").innerHTML = "你已游玩"+gametimes+"次";
}
let paused = false
function freeze(){
    paused = !paused
}
function main() {
    gameloop = setTimeout(function tick() {
        clearCanvas()
        if(!paused) {
            moveSnake()
        }
            drawSnake()
            drawFood()
        main()
    },speed);
}
function setposition(){
     snake =[
    {x:10*SnakeSize,y:10*SnakeSize},
    {x:9*SnakeSize,y:10*SnakeSize},
    {x:8*SnakeSize,y:10*SnakeSize},
        ]
     score = 0
    speed = 200
    movefeetx = SnakeSize;
    movefeety = 0
    drawSnake()
    NewFood()
}
function reset(){
    clearTimeout(gameloop)
    setposition()
    document.getElementById("score").innerHTML = "分数:"+0+"分喵"
}
</script>
</html>